captainVersion: 4
services:
    $$cap_appname:
        caproverExtra:
            dockerfileLines:
                - FROM telegraf:$$cap_telegraf_version
                - RUN apt-get -y update; apt-get -y install curl
                - RUN curl -L https://raw.githubusercontent.com/Utopia-Members-Club-Inc/one-click-apps/refs/heads/main/conf/telegraf.conf > /etc/telegraf/telegraf.conf
                - RUN sed -i 's/\$\$cap_influxdb_host/$INFLUXDB_HOST/g' /etc/telegraf/telegraf.conf
                - RUN sed -i 's/\$\$cap_influxdb_port/$INFLUXDB_PORT/g' /etc/telegraf/telegraf.conf
                - RUN sed -i 's/\$\$cap_influxdb_db_name/$INFLUXDB_DB_NAME/g' /etc/telegraf/telegraf.conf
                - RUN sed -i 's/\$\$cap_influxdb_admin_user/$INFLUXDB_ADMIN_USER/g' /etc/telegraf/telegraf.conf
                - RUN sed -i 's/\$\$cap_influxdb_admin_password/$INFLUXDB_ADMIN_PASSWORD/g' /etc/telegraf/telegraf.conf
                - CMD ["telegraf", "-config", "/etc/telegraf/telegraf.conf"]
        restart: always
        environment:
            - INFLUXDB_HOST=$$cap_influxdb_host
            - INFLUXDB_PORT=$$cap_influxdb_port
            - INFLUXDB_DB_NAME=$$cap_influxdb_db_name
            - INFLUXDB_ADMIN_USER=$$cap_influxdb_admin_user
            - INFLUXDB_ADMIN_PASSWORD=$$cap_influxdb_admin_password
caproverOneClickApp:
    variables:
        - id: $$cap_telegraf_version
          label: Telegraf Version
          description: See https://hub.docker.com/_/telegraf/tags for supported versions.
          defaultValue: '1.34.4'
          validRegex: /^([^\s^\/])+$/

        - id: $$cap_influxdb_host
          label: InfluxDB Database host
          description: The port of the database.
          defaultValue: 'srv-captain--apps-influx-db-db'

        - id: $$cap_influxdb_port
          label: InfluxDB Database port
          description: The port of the database.
          defaultValue: '8086'

        - id: $$cap_influxdb_db_name
          label: InfluxDB Database hostname
          description: The hostname of the database.
          defaultValue: 'telegraf'

        - id: $$cap_influxdb_admin_user
          label: InfluxDB Admin username
          description: The username of the database user.
          defaultValue: 'admin'

        - id: $$cap_influxdb_admin_password
          label: InfluxDB Admin password
          description: The password of the database user.
          defaultValue: 'admin'

    instructions:
        start: Telegraf is a plugin-driven server agent for collecting & reporting metrics.
        end: Telegraf, InfluxDB, and Grafana Deployment is Initializing...
    displayName: Telegraf Custom
    isOfficial: false
